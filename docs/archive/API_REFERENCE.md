# API Reference

This document describes the data structures, Firebase collections, and key functions used in the Devfest Competition Form application.

## Table of Contents

1. [Data Structures](#data-structures)
2. [Firebase Collections](#firebase-collections)
3. [Firebase Storage](#firebase-storage)
4. [Key Functions](#key-functions)
5. [Authentication](#authentication)
6. [Environment Variables](#environment-variables)

## Data Structures

### Submission Interface

Location: `types/submission.ts`

```typescript
interface Submission {
  id?: string;                              // Firestore document ID (auto-generated)
  fullName: string;                         // User's full name
  email: string;                            // User's email address
  githubUrl: string;                        // GitHub repository URL
  appPurpose: string;                       // Description of the AI project
  screenshots: string[];                    // Array of Firebase Storage URLs
  linkedinUrl?: string;                     // Optional LinkedIn profile URL
  socialLinks?: string;                     // Optional other social media links
  userId: string;                           // Clerk user ID
  userEmail: string;                        // Clerk user email
  createdAt: Date;                          // Submission timestamp
  place?: "first" | "second" | "third" | null;  // Winner designation
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | No | Auto-generated by Firestore |
| `fullName` | string | Yes | Submitter's full name |
| `email` | string | Yes | Contact email address |
| `githubUrl` | string | Yes | Must be valid URL to GitHub repository |
| `appPurpose` | string | Yes | Detailed project description (min 10 chars) |
| `screenshots` | string[] | Yes | 1-5 image URLs from Firebase Storage |
| `linkedinUrl` | string | No | Optional LinkedIn profile |
| `socialLinks` | string | No | Optional additional social links |
| `userId` | string | Yes | Automatically set from Clerk |
| `userEmail` | string | Yes | Automatically set from Clerk |
| `createdAt` | Date | Yes | Automatically set on submission |
| `place` | string | No | Set by admin: "first", "second", "third", or null |

## Firebase Collections

### submissions Collection

**Path**: `/submissions/{submissionId}`

**Purpose**: Stores all project submissions

**Security Rules**:
```javascript
match /submissions/{submission} {
  allow read: if true;
  allow create: if request.auth != null;
  allow update: if request.auth != null;
}
```

**Indexes**: 
- `createdAt` (descending) - for chronological listing

**Example Document**:
```json
{
  "fullName": "John Doe",
  "email": "john@example.com",
  "githubUrl": "https://github.com/johndoe/ai-project",
  "appPurpose": "An AI-powered tool that...",
  "screenshots": [
    "https://firebasestorage.googleapis.com/...",
    "https://firebasestorage.googleapis.com/..."
  ],
  "linkedinUrl": "https://linkedin.com/in/johndoe",
  "socialLinks": "https://twitter.com/johndoe",
  "userId": "user_2abc123def",
  "userEmail": "john@example.com",
  "createdAt": Timestamp(1234567890),
  "place": "first"
}
```

## Firebase Storage

### screenshots Folder

**Path**: `/screenshots/{timestamp}_{filename}`

**Purpose**: Stores uploaded project screenshots

**Naming Convention**: `{timestamp}_{original_filename}`
- Example: `1699876543210_screenshot.png`

**Security Rules**:
```javascript
match /screenshots/{allPaths=**} {
  allow read: if true;
  allow write: if request.auth != null 
               && request.resource.size < 10 * 1024 * 1024;
}
```

**Constraints**:
- Maximum file size: 10 MB
- Allowed formats: Any image type (png, jpg, jpeg, gif, webp)
- Maximum files per submission: 5

## Key Functions

### uploadScreenshots

Location: `app/submit/page.tsx`

```typescript
const uploadScreenshots = async (): Promise<string[]> => {
  const urls: string[] = [];
  
  for (const file of screenshots) {
    const storageRef = ref(storage, `screenshots/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    urls.push(url);
  }
  
  return urls;
};
```

**Purpose**: Uploads multiple image files to Firebase Storage

**Parameters**: None (uses component state)

**Returns**: `Promise<string[]>` - Array of download URLs

**Side Effects**: 
- Creates files in Firebase Storage
- Generates public download URLs

### handleSubmit

Location: `app/submit/page.tsx`

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // Validation
  if (!user) return;
  if (screenshots.length === 0) return;
  
  setLoading(true);
  
  try {
    // Upload screenshots
    const screenshotUrls = await uploadScreenshots();
    
    // Save to Firestore
    await addDoc(collection(db, "submissions"), {
      ...formData,
      screenshots: screenshotUrls,
      userId: user.id,
      userEmail: user.emailAddresses[0]?.emailAddress,
      createdAt: new Date(),
      place: null,
    });
    
    // Success handling
  } catch (error) {
    // Error handling
  } finally {
    setLoading(false);
  }
};
```

**Purpose**: Handles form submission process

**Process**:
1. Validates user authentication
2. Validates required fields
3. Uploads screenshots to Storage
4. Saves submission data to Firestore
5. Redirects to gallery

### updateWinner

Location: `app/admin/page.tsx`

```typescript
const updateWinner = async (
  submissionId: string, 
  place: "first" | "second" | "third" | null
) => {
  try {
    const submissionRef = doc(db, "submissions", submissionId);
    await updateDoc(submissionRef, { place });
    
    // Update local state
    setSubmissions(submissions.map(sub => 
      sub.id === submissionId ? { ...sub, place } : sub
    ));
    
    // Show success toast
  } catch (error) {
    // Error handling
  }
};
```

**Purpose**: Updates winner designation for a submission

**Parameters**:
- `submissionId`: Firestore document ID
- `place`: Winner position or null to remove

**Returns**: `Promise<void>`

**Side Effects**:
- Updates Firestore document
- Updates local state
- Shows toast notification

### fetchSubmissions

Location: `app/gallery/page.tsx` and `app/admin/page.tsx`

```typescript
const fetchSubmissions = async () => {
  try {
    const q = query(
      collection(db, "submissions"), 
      orderBy("createdAt", "desc")
    );
    const querySnapshot = await getDocs(q);
    const data = querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
      createdAt: doc.data().createdAt?.toDate(),
    })) as Submission[];
    setSubmissions(data);
  } catch (error) {
    console.error("Error fetching submissions:", error);
  } finally {
    setLoading(false);
  }
};
```

**Purpose**: Retrieves all submissions from Firestore

**Returns**: `Promise<void>`

**Side Effects**:
- Updates component state with submissions
- Converts Firestore timestamps to Date objects

## Authentication

### Clerk Integration

**Provider**: `@clerk/nextjs`

**Setup**: 
```tsx
<ClerkProvider>
  <App />
</ClerkProvider>
```

**Protected Routes**: Defined in `middleware.ts`

```typescript
const isProtectedRoute = createRouteMatcher([
  "/submit(.*)",
  "/admin(.*)",
]);
```

### User Access Levels

1. **Anonymous**: Can view home and gallery
2. **Authenticated**: Can submit projects
3. **Admin**: Can manage submissions and select winners

**Admin Check**:
```typescript
const isAdmin = user?.emailAddresses?.[0]?.emailAddress === 
                process.env.NEXT_PUBLIC_ADMIN_EMAIL;
```

## Environment Variables

### Required Variables

| Variable | Type | Description |
|----------|------|-------------|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | Public | Clerk publishable key |
| `CLERK_SECRET_KEY` | Secret | Clerk secret key |
| `NEXT_PUBLIC_FIREBASE_API_KEY` | Public | Firebase API key |
| `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN` | Public | Firebase auth domain |
| `NEXT_PUBLIC_FIREBASE_PROJECT_ID` | Public | Firebase project ID |
| `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET` | Public | Firebase storage bucket |
| `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID` | Public | Firebase messaging ID |
| `NEXT_PUBLIC_FIREBASE_APP_ID` | Public | Firebase app ID |
| `NEXT_PUBLIC_ADMIN_EMAIL` | Public | Admin user email |

### Variable Prefixes

- `NEXT_PUBLIC_*`: Available in browser
- No prefix: Server-side only

## Error Handling

### Common Error Cases

1. **Authentication Errors**:
   - User not signed in
   - Invalid Clerk credentials
   - Session expired

2. **Firebase Errors**:
   - Permission denied
   - Network errors
   - Quota exceeded
   - Invalid data format

3. **Validation Errors**:
   - Missing required fields
   - Invalid URL format
   - File size exceeded
   - Too many files

### Error Response Pattern

```typescript
try {
  // Operation
} catch (error) {
  console.error("Error description:", error);
  toast({
    title: "Error",
    description: "User-friendly error message",
    variant: "destructive",
  });
}
```

## Rate Limits

### Firebase Quotas (Free Tier)

- **Firestore Reads**: 50,000/day
- **Firestore Writes**: 20,000/day
- **Storage**: 5 GB
- **Storage Downloads**: 1 GB/day

### Clerk Quotas (Free Tier)

- **Monthly Active Users**: 10,000
- **User Profile API calls**: Unlimited

### Recommended Limits

- Max submissions per user: Not limited (can be implemented)
- Max file size: 10 MB per file
- Max files per submission: 5

## Best Practices

1. **Always validate on both client and server**
2. **Use TypeScript for type safety**
3. **Handle all async operations with try-catch**
4. **Show user feedback for all operations**
5. **Log errors for debugging**
6. **Keep security rules restrictive**
7. **Validate file types and sizes**
8. **Use indexes for common queries**

---

For more information, refer to:
- [Firebase Documentation](https://firebase.google.com/docs)
- [Clerk Documentation](https://clerk.com/docs)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)

